# Домашнее задание 03 Шардинг монги и рбак <br/>
<br/>
---
<br/>
Задание:  <br/>
Настроить несколько рс<br/>
Подключить шардинг<br/>
Посмотреть как робит<br/>
Настроить рбак<br/>
Посмотреть как робит<br/>
Пункт "посмтореть что будет" если у рс поронять ноды<br/>
<br/>
--- 
<br/>
Решение: <br/>
<br/>
SHARDING :<br/>
для начала поднять нужно 2 рс, 1 конфиг рс и 1 mongosh : <br/>
docker-compose -f ./compose/rs1/docker-compose.yaml <br/>
docker-compose -f ./compose/rs2/docker-compose.yaml<br/>
docker-compose -f ./compose/config/docker-compose.yaml<br/>
docker-compose -f ./compose/shard/docker-compose.yaml<br/>
настроить : <br/>
docker exec -ti rs1_mongo1_1 mongo <br/>
rs.initiate({"_id":"rs1", members : [{"_id": 1, host: "10.100.100.83:21117"},{"_id": 2, host: "10.100.100.83:21217"},{"_id": 3, host: "10.100.100.83:21317"}]});<br/>
docker exec -ti rs2_mongo1_1 mongo<br/>
rs.initiate({"_id":"rs2", members : [{"_id": 1, host: "10.100.100.83:22117"},{"_id": 2, host: "10.100.100.83:22217"},{"_id": 3, host: "10.100.100.83:22317"}]});<br/>
docker exec -ti config_mongo1_1 mongo<br/>
rs.initiate({"_id":"rsconf", configsvr: true, members : [{"_id": 1, host: "10.100.100.83:23117"},{"_id": 2, host: "10.100.100.83:23217"},{"_id": 3, host: "10.100.100.83:23317"}]});<br/>
docker exec -ti shard_mongos_1 mongo<br/>
sh.addShard("rs1/10.100.100.83:21117,10.100.100.83:21217,10.100.100.83:21317")<br/>
sh.addShard("rs2/10.100.100.83:22117,10.100.100.83:22217,10.100.100.83:22317")<br/>
Если все рс успели подняться, команды отработают без ошибок. <br/>
Дальше поиграть с данными - пример в ./compose/shard/console там вывод наполнения шарда данными. <br/>
<br/>
RBAC : <br/>
Для того чтобы рбак заработал в монге при докере достаточно просто указать пароль рута, а при установке из пакетного манагера нужно в конфиг добавить параметр <br/>
---<br/>
security:<br/>
  keyFile: /usr/local/etc/mongod/keyfile.txt<br/>
---<br/>
Рбак в монге странный. <br/>
в общем можно создать зверя который имеет доступ к любой базе, но не может к ней подключиться =) <br/>
db.createUser({user: "user" , pwd: "password", roles: [  "readWriteAnyDatabase" ]}) <br/>
тоесть права на все базы будут, но надо сначала подключиться к серверу без указания базы, а потом переключиться на нужную.<br/> 
так же можно создать пользователя который не может подключиться к серверу без указания базы на которую у него есть права. <br/>
use db tost <br/>
db.createUser({ user: "user", pwd: "password", roles: [{ role: "readWrite", db: "tost"}]})<br/>
<br/>
TESTS : <br/>
Если ронять сервера они будут лежать. У монги не плохой протокол кворума который быстро и эффктивно определяет упавшие/поднявшиеся ноды.(не то что коросинк)<br/>
Тут от меня кажется ждут слов "Для работоспособности RS нужно не менее n/2+1 рабочих нод кластера."<br/>